name: Auto Merge when checks pass

on:
  pull_request:
    types:
      - labeled
      - synchronize
      - reopened
      - ready_for_review

concurrency:
  group: automerge-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  auto-merge:
    # Nur laufen, wenn das Label "auto-merge" auf dem PR ist
    if: contains(join(github.event.pull_request.labels.*.name, ','), 'auto-merge')
    runs-on: ubuntu-latest

    # WICHTIG: Rechte f√ºr Auto-Merge einschalten
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Wait for Lint (required)
        uses: peter-evans/wait-for-check@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: lint
          wait-interval: 10
          timeout: 20m

      - name: Wait for Build (required)
        uses: peter-evans/wait-for-check@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: build
          wait-interval: 10
          timeout: 20m

      - name: Enable auto-merge (squash)
        uses: peter-evans/enable-pull-request-automerge@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
